\documentclass[11pt]{article}
%\usepackage[margin=1.25in]{geometry}                % See geometry.pdf to learn the layout options. There are lots.
%\geometry{letterpaper}                   % ... or a4paper or a5paper or ... 
%\geometry{landscape}                % Activate for for rotated page geometry
%\usepackage[parfill]{parskip}    % Activate to begin paragraphs with an empty line rather than an indent
%\usepackage{natbib}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{epstopdf}
\usepackage{hyperref}
\usepackage{setspace}
\usepackage{natbib}
%\usepackage{verbatim}

%\usepackage{pslatex}
%\usepackage{fullpage}
\DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}

\usepackage{amsmath}

\newtheorem{definition}{Definition}
\newcommand{\mydef}[1]{\begin{definition}#1\end{definition}}

\begin{document}
\title{Inferring Unobserved Firm Networks}
\author{Jesse Tweedle}
\date{}
%\address{Statistics Canada\\University of Calgary}
%\email{jesse.tweedle@gmail.com}


 \maketitle

\begin{abstract}

Use data and machine learning to infer unobserved firm-firm trading networks. Given data on firm characteristics, and a detailed geographic trading network, infer the unobserved firm-firm trading network that matches the Canadian national accounts.

\end{abstract}

\section{Equations}

The first set of equations to match is 
\begin{gather}
\sum_{r=1}^R M_r a_{ri} + \sum_{j=1}^N s_j g_{ji} = s_i , \quad i = 1,\ldots, N
\end{gather}
Which I rewrite as (and add important other restrictions)
\begin{gather}
\label{eq:mc}
M \cdot a_{\cdot i} + s \cdot g_{\cdot i} = s_i, \quad i = 1,\ldots, N \\
a_{ri} \geq 0, \quad a_{ri} - 1 \leq 0 \\
g_{ij} \geq 0, \quad g_{ij} - 1\leq 0 \\
g_{ii} = 0 \\
\sum_{i \in N} a_{ri} = 1 \label{eq:rowsuma}\\
\sum_{j \in N} g_{ij} = 1-\beta_i\label{eq:rowsumg}
\end{gather}

\[
X_{mc} = 
\begin{bmatrix}
    M & 0 &\dots  & 0 & s & 0 & \dots & 0\\
    0 & M &\dots  & 0 & 0 & s &\dots  & 0\\
    \vdots & \vdots & \ddots & \vdots & \vdots & \vdots & \ddots & \vdots \\
    0 & 0 & \dots  & M & 0 & 0 &\dots  & s
\end{bmatrix}
\]

Then $X$ has dimensions $N \times (R+N)N$ (this may be a problem later---it's sparse but still has exactly $(R+N)N$ non-zero entries, which is too many if $N$ is any economically reasonable number). $mc$ stands for market clearing, and represents Equation \eqref{eq:mc}.

There are also $R+N$ equations that require the expenditure shares add up to 1.

\[
X_{a} = 
\begin{bmatrix}
    1 & 0 &\dots  & 0 & \dots & 1 & 0 & \dots & 0\\
    0 & 1 &\dots  & 0 & \dots & 0 & 1 &\dots  & 0\\
    \vdots & \vdots & \ddots & \vdots & \dots & \vdots & \vdots & \ddots & \vdots \\
    0 & 0 & \dots  & 1 & \dots & 0 & 0 &\dots  & 1
\end{bmatrix} = 
\underbrace{\begin{bmatrix}
I_R \ldots I_R
\end{bmatrix}}_{R \times R N}
\]

And $X_g$ is similar,
\[
X_{g} = 
\underbrace{\begin{bmatrix}
I_N \ldots I_N
\end{bmatrix}}_{N \times N^2}
\]
Combine those two into $Z$
\[
Z = 
\begin{bmatrix}
X_a & 0 \\
0 & X_g
\end{bmatrix}
\]


And then construct $X$ as
\[
X = 
\begin{bmatrix}
X_{mc} \\
Z
\end{bmatrix}
\]

And 
\[
c = 
\begin{bmatrix}
s \\
1_R \\
1-\beta
\end{bmatrix}
\]

Let $y$ be a combined vectorized $A$ and $G$, so that $y$ is a vector with length $(R + N) N$. 
\[ 
y' = (a_{11},a_{21},\ldots,a_{R1},\ldots,a_{1N},\ldots,a_{RN},g_{11},g_{21},\ldots,g_{N1},g_{1N},\ldots,g_{NN}) 
\]
Or, write $a_{\cdot i}$ as the $i$-th column of $A$, and so on.
\[ y' = (a_{\cdot 1},\ldots,a_{ \cdot N},g_{ \cdot 1},\ldots,g_{ \cdot N})\]

We have the three things we need: $c$ is $(N + R + N) \times 1$, $y$ is $(RN + N^2)\times 1$, and $X$ is $(N+R+N)\times (RN + N^2)$, and the set of equations to solve is:

\begin{gather}
X y = c
\end{gather}

Or,
\[
\underbrace{\begin{bmatrix}
    I & 0 &\dots  & 0 & s & 0 & \dots & 0\\
    0 & I &\dots  & 0 & 0 & s &\dots  & 0\\
    \vdots & \vdots & \ddots & \vdots & \vdots & \vdots & \ddots & \vdots \\
    0 & 0 & \dots  & I & 0 & 0 &\dots  & s
\end{bmatrix}}_{N \times (RN+N^2)}
\underbrace{\begin{bmatrix}
	a_{\cdot 1} \\
	a_{\cdot N} \\
	\vdots \\
	g_{\cdot 1} \\
	g_{\cdot N} 	
\end{bmatrix}}_{(RN+N^2) \times 1}
=
\underbrace{\begin{bmatrix}
	s_1 \\
	\vdots \\
	s_{N} 	
\end{bmatrix}}_{N\times 1}
\]

And the minimization problem is:
%Other characteristics are $c$, $N\times1$ (or more), and $X$, $N \times (RN + N^2)$. Then the problem is 
\begin{gather}
\min_y || X y - c||_2 + \lambda || y ||_1
\end{gather}

Or:
\begin{gather}
\min_y || X y - c||_2 + \lambda \left( (1-\alpha) \frac{1}{2} || y ||^2_{\ell 2} + \alpha || y ||_{\ell 1} \right)
\end{gather}


This is an underdetermined system, since the number of variables is much more than the number of ``observations'' (which, in this case, are firm characteristics and later, national accounts). The estimated $y$ gives the most sparse implied network that matches the national accounts. Density can be increased by using elastic-net (which combines $\ell 1$ and $\ell 2$ regularization).  To use the geographic trade network, we assume the implied firm-firm network identified from that as a subset of the true network, and leave those edges out of the penalty $||y||$.

Now use \texttt{glmnet} to solve this problem. Simulation testing: set $R$, $N$, set , draw random $\beta_i$ and $s_i$, random firm locations $r_i$, calculate regional income $I_r = \sum_{i \in r} \beta_i s_i$, then construct $X$ and $c$, then run glmnet for different $R,N$, skewness in $s$ and so on. See if anything works.

\section{First try}

It's not bad. If not sparse, everything looks pretty great, every equation is satisfied or close to it. When it's sparse (say 5\%), the sizes aren't terrible (0.9 $R^2$ for non-zero predicted sizes, and 0.99 $R^2$ for firms above the median). Rank is almost always preserved, but the bottom of the distribution curves disastrously. The other problem: the sum equations \eqref{eq:rowsuma} and \eqref{eq:rowsumg} don't seem to hold ever.  One solution might be post-processing of the $A$ and $G$.

\section{Next up}

To solve the dimensionality problem, the idea is to solve the problem
\begin{gather}
\min_y || X y - c||_{\ell 2} + \lambda || y ||_{\ell 1}
\end{gather}

By row?
\begin{gather}
\min_{y} || X_{i \cdot} y - c_i || + \lambda || y ||_{\ell 1} 
\end{gather}

But of course lots of $X_{i \cdot}$ are 0, so we can make that much smaller, say
\[
\tilde{X}_i \tilde{y}_i - c_i = 
\begin{bmatrix}
	M_1 & \dots & M_R & s_1 & \dots & s_N
\end{bmatrix}
\begin{bmatrix}
	a_{1i} \\
	\vdots \\
	a_{Ri} \\
	g_{1i} \\
	\vdots \\
	g_{Ni}
\end{bmatrix}
-
s_i
\]

So solve this problem for each $i$; there's $R+N$ unknowns and one equation. So solve this $i$ problem, then switch to the $i+1$ problem. That's different than the \texttt{glasso} problem though, they permute the columns, and sort of solve the whole thing?


%Use the implied $A$ and $G$ to solve the equations and see how close it gets. Check sparseness, check network measures, and so on. Does each firm have at least one customer, at least one supplier? Make sure $g_{ii}=0$ somehow?

 
%Topics: node identification and link prediction in multi-layer networks. Link prediction. Multi-plex networks, multi-layer networks, complex networks. Matching across layers. Node matching across networks / graphs.

%Subtitle: application to firm-firm trade network.


%\subsection{Algorithm}
%But, if matrix dense, $E=[1]$, then exact solution can be found, and $|| X - \hat{X} ||_2 =0$. But $\lambda || E ||_1 = \lambda N^2$. So idea is to reduce $E$ as much as possible, but the thing still makes sense. Or, I can ditch the benchmarking altogether, since it should be exact, or at least close. Aka, if it's not close, ditch the solution altogether. How to pick algorithm? Some edge-picking algorithm. But make sure...stuff still works out.

\bibliographystyle{chicago}
\bibliography{inferring-firm-networks-2}

\end{document}








